#!/usr/bin/env ruby

#--
# Copyright 2009 by Stefan Rusterholz.
# All rights reserved.
# See LICENSE.txt for permissions.
#++



require 'optparse'
begin
  require 'test'
rescue LoadError
  begin
    require 'rubygems'
    require 'test'
  rescue LoadError
    $LOAD_PATH.unshift(File.expand_path("#{__FILE__}/../../lib"))
    require 'test'
  end
end



format      = ENV['FORMAT'] || 'cli'
interactive = ['false', nil].include?(ENV['INTERACTIVE']) ? false : true
setup_path  = nil

opts = OptionParser.new("", 24, '  ') do |opts|
  opts.banner = "Usage: baretest [options] [glob, ...]"

  opts.separator "Glob defaults to 'test/**/*.rb'"
  opts.separator "Providing a directory as glob is equivalent to dir/**/*.rb\n"
  opts.separator "Options:"

  opts.on("-f", "--format FORMAT", "use FORMAT for output") { |use|
    format = use
  }

  opts.on("-F", "--formats", "show available formats") { |use|
    Dir.glob("{#{$LOAD_PATH.join(',')}}/test/run/*.rb") { |path|
      puts "- #{File.basename(path, '.rb')}"
    }
    exit
  }

  opts.on("-d", "--debug", "set debugging flags (set $DEBUG to true)") {
    $DEBUG = true
  }

  opts.on("-i", "--interactive", "drop into IRB on error or failure") {
    interactive = true
  }

  opts.on("-s", "--setup FILE", "specify setup file") { |path|
    setup_path = path
  }

  opts.on("-v", "--version", "print the version and exit") {
    puts "baretest version 0.2"
    exit
  }

  opts.on("-w", "--warn", "turn warnings on for your script") {
    $VERBOSE = true
  }

  opts.parse! ARGV
end

if ARGV.empty? then
  setup_path ||= 'test/setup.rb'
  load(setup_path) if File.exist?(setup_path)
  Dir.glob('test/lib/**/*.rb') { |path|
    helper_path = path.sub(%r{^test/lib/}, 'test/helper/')
    load(helper_path) if File.exist?(helper_path)
    load(path)
  }
else
  load(setup_path) if setup_path && File.exist?(setup_path)
  ARGV.each { |path|
    if File.directory?(path) then
      Dir.glob("#{path}/**/*.rb") { load(path) }
    else
      Dir.glob(path) { load(path) }
    end
  }
end

Test.run(:format => format, :interactive => interactive)
